---
title: "DESeq_separate_analysis"
output: html_notebook
---


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(DESeq2)
library(ggplot2)
devtools::load_all(reset=FALSE)

```


```{r}
# Function to get the new subject id
Get_New_Subject_ID = function(data_temp) {
  old = factor(data_temp$Subject)
  new_sub = paste0("S", 1:length(levels(old)))
  names(new_sub) = levels(old)
  return(data.frame(new_sub))
}


```


```{r}

load("genus.rda")

Tolerance::sample_metadata %>% head

sample_metadata$Groupe = as.factor(sample_metadata$Groupe)
str(sample_metadata$Groupe)
sample_metadata$Groupe = relevel(sample_metadata$Groupe, ref = "CP") 
# > str(sample_metadata$Groupe)
#  Factor w/ 2 levels "CP","ATN": 1 2 2 1 2 2 2 1 2 1 ...
sample_metadata$Groupe_dose = as.factor(sample_metadata$Groupe_dose)
sample_metadata$Groupe_dose = relevel(sample_metadata$Groupe_dose, ref = "CP.1") 


```


```{r}

# separate dose group in genus and sample_metadata files

## sample_metadata file

sample_metadata_dose3 = sample_metadata[sample_metadata$Doses=="3",]
sample_metadata_dose3$Groupe = relevel(sample_metadata_dose3$Groupe, ref = "CP") 
sample_metadata_dose3$Groupe_dose = relevel(sample_metadata_dose3$Groupe_dose, ref = "CP.3") 
sample_metadata_dose3 %>% head
save(sample_metadata_dose3, file="../data/sample_metadata_dose3.rda")

sample_metadata_dose1 = sample_metadata[sample_metadata$Doses=="1",]
sample_metadata_dose1$Groupe = relevel(sample_metadata_dose1$Groupe, ref = "CP") 
sample_metadata_dose1$Groupe_dose = relevel(sample_metadata_dose1$Groupe_dose, ref = "CP.1") 
sample_metadata_dose1 %>% head
save(sample_metadata_dose1, file="../data/sample_metadata_dose1.rda")


## genus file

str(genus)
rownames(genus)=genus$genus
genus_tmp = genus[,-1]
genus_dose3 = genus_tmp[match(sample_metadata_dose3$samplenr, colnames(genus_tmp))]
genus_dose3$genus= rownames(genus_dose3)
genus= genus_dose3
save(genus, file="genus_dose3.rda")

```

## Filter abundant taxa
```{r}
# for genus dose 3x

genus %>%
  mutate_if(is.numeric,function(x)(x/sum(x))) %>%
  tibble::column_to_rownames("genus") %>%
  BiotypeR::noise.removal(percent=0.1) %>% rownames() -> genus_select



genus %>%
  filter(genus %in% genus_select) %>%
  tibble::column_to_rownames("genus") %>%
  t %>% as.data.frame-> genus_count


Tolerance::sample_metadata_dose3 %>%
  tibble::column_to_rownames("samplenr") %>% head
  


```
