---
title: "FMP functions analysis"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}

library(ggplot2)
library(dplyr)
devtools::load_all()


```




```{r}

data("kegg")
data("cazy")
data("MSP_tax")
data("sample_metadata_metaG")

```


```{r}

load("../data-raw/tolerance_MSP_table.rda")

counts_scaled = vroom::vroom("../data-raw/scaled_normalization_counts.txt")





```




```{r}


sample_metadata_metaG = data.frame(seq=colnames(counts_scaled)[-1], samplenr=colnames(counts_scaled)[-1] %>% stringr::str_split_fixed(pattern="_", 2) %>% .[,1]) %>%
  merge(sample_metadata_metaG, by="samplenr")


```




```{r}
head(cazy)
head(kegg)
head(tolerance_MSP_table)
head(MSP_tax)


```



```{r}

cazy %>%
  tidyr::separate(gene_name,  into=c("gene_id","project"), sep="\\|")





```



```{r}
#msp_lrhamnosus
#msp_1025

tolerance_MSP_table %>% head


rbind(

kegg %>%
  filter(gene_name %in% grep("Lr10",gene_name, value = TRUE)) %>%
  tidyr::separate(gene_name,  into=c("gene_name",LETTERS[1:6]), sep="\\|" ) %>%
  select(gene_name,KO)
,

kegg %>%
  filter(!(gene_name %in% grep("Lr10",gene_name, value = TRUE))) %>%
  mutate(gene_name = gsub("\\|MetaHIT","", gene_name) ) %>%
  select(gene_name,KO)

) %>% merge(

#merge

rbind(

tolerance_MSP_table %>%
  #filter(gene_name %in% grep("Lr10",gene_name, value = TRUE)) %>%
  filter(msp_name %in% c("msp_lrhamnosus")) %>%
  tidyr::separate(gene_name,  into=c("gene_name",LETTERS[1:6]), sep="\\|" ) %>%
  select(msp_name,module_name,gene_id,gene_name,gene_length)
,

tolerance_MSP_table %>%
  filter(!(msp_name %in% c("msp_lrhamnosus"))) %>%
  mutate(gene_name = gsub("\\|MetaHIT","", gene_name))

),

by="gene_name"


) %>%

filter(msp_name %in% c("msp_1025","msp_lrhamnosus"))


```




```{r}

counts_scaled %>% 
  dplyr::rename("gene_name" = 1) %>%
  #sample_frac(0.05) %>%
  #filter(gene_name %in% grep("Lr10",gene_name, value = TRUE)) %>%
  merge(tolerance_MSP_table, by="gene_name", all.x = TRUE) %>%
  #filter(msp_name %in% c("msp_1025") | gene_name %in% grep("Lpp121|Lpp1",gene_name, value = TRUE) ) %>%
  #filter(msp_name %in% c("msp_lrhamnosus") & gene_name %in% grep("Lpp121|Lpp1",gene_name, value = TRUE) ) %>%
  filter(msp_name %in% c("msp_1025","msp_lrhamnosus") | gene_name %in% grep("Lpp121|Lpp1|Lr10",gene_name, value = TRUE)) %>% 
  select(msp_name,gene_name) -> genes_names_from_products



```




```{r}



kegg %>% #head(200) %>%
  #sample_frac(0.05) %>%
  tidyr::separate(KO, sep=",", into=as.character(1:100)) %>%
  tidyr::separate(gene_name, into=c("gene_name",LETTERS[1:6]), sep="\\|") %>%
  select(-A,-B,-C,-D,-E,-F) %>%
  reshape2::melt(id.vars="gene_name") %>%
  select(gene_name,value) %>%
  dplyr::rename(KO=value) %>%
  na.omit() %>%
  as_tibble() -> kegg_melt



kegg_melt %>% dim




```




## aggregate count at KEGG levels
```{r}

kegg_melt %>% #sample_frac(0.05) %>%

  merge(.,
        counts_scaled %>% #head %>% 
          dplyr::rename(gene_name = 1) %>% 
          tidyr::separate(gene_name, into=c("gene_name",LETTERS[1:6]), sep="\\|") %>%
          select(-A,-B,-C,-D,-E,-F) , 
        by="gene_name") %>%
  select(-gene_name) %>%
  group_by(KO) %>%
  summarise_all(sum) -> KO_counts

write.csv2(KO_counts, file="KO_counts.csv")

KO_counts %>% head



```


```{r}

kegg_melt %>% #sample_frac(0.05) %>%

  merge(.,
        counts_scaled %>% #head %>% 
          dplyr::rename(gene_name = 1) %>% 
          filter(gene_name %in% genes_names_from_products$gene_name) %>%
          tidyr::separate(gene_name, into=c("gene_name",LETTERS[1:6]), sep="\\|") %>%
          select(-A,-B,-C,-D,-E,-F) , 
        by="gene_name") %>%
  select(-gene_name) %>%
  group_by(KO) %>%
  summarise_all(sum) -> KO_counts_Lactobacillus

write.csv2(KO_counts_Lactobacillus, file="KO_counts_Lactobacillus.csv")

KO_counts_Lactobacillus %>% head




```


```{r}

KO_counts %>%
  reshape2::melt() %>%
  merge(
          KO_counts_Lactobacillus %>% reshape2::melt(), 
          by=c("KO","variable")
          ) %>%
  mutate(value = value.y/(value.x+1)) %>%
  arrange(desc(value)) -> KO_contrib_per_individual


#save(KO_contrib_per_individual, file="KO_contrib_per_individual.rda")


KO_contrib_per_individual %>%
  filter(value.y>100) %>%
  arrange(desc(value))


KO_contrib_per_individual %>%
  #group_by(KO) %>%
  #summarise(value=mean(value)) %>%
  #arrange(value) %>%
  #filter(value.y>10) %>%
  filter(KO %in% c("K03043","K04043")) %>%
  ggplot() + geom_point(aes(y=value.x,x=variable)) + scale_y_log10()
  

#to DO : cross with group & visit


#K03043
#K04043


```


```{r}

sample_metadata_metaG %>%
  filter(Subject!="276001094") %>% #exclude contaminated CP3
  merge(KO_contrib_per_individual, by.x="seq", by.y="variable") %>%
  filter(Visit %in% c("V2") | group == "V4_CP.3") %>%
  group_by(seq) %>%
  mutate(sum=sum(value.x)) %>%
  ungroup() %>%
  mutate(prop.x=value.x/sum) %>%
  filter(prop.x> 0.0001) %>%
  ggplot() + geom_point(aes(x=value+10^-6,y=prop.x+10^-6)) + scale_x_log10() + scale_y_log10()


sample_metadata_metaG %>%
  filter(Subject!="276001094") %>% #exclude contaminated CP3
  merge(KO_contrib_per_individual, by.x="seq", by.y="variable") %>%
  filter(group == "V4_ATN.3") %>%
  group_by(seq) %>%
  mutate(sum=sum(value.x)) %>%
  ungroup() %>%
  mutate(prop.x=value.x/sum) %>%
  filter(prop.x> 0.0001) %>%
  ggplot() + geom_point(aes(x=value+10^-6,y=prop.x+10^-6)) + scale_x_log10() + scale_y_log10()

  
sample_metadata_metaG %>%
  filter(Subject!="276001094") %>% #exclude contaminated CP3
  merge(KO_contrib_per_individual, by.x="seq", by.y="variable") %>%
  #filter(group == "V4_ATN.3") %>%
  #filter(Visit != "V4") %>%
  group_by(seq) %>%
  mutate(sum_kegg=sum(value.x)) %>%
  ungroup() %>%
  mutate(prop.x=value.x/sum_kegg, prop.y=value.y/sum_kegg) %>%
  #filter(prop.x> 0.0001) %>%
  ggplot() + geom_point(aes(x=prop.y+10^-6,y=prop.x+10^-6, col=group), alpha=0.5) + 
  scale_x_log10() + scale_y_log10() +
  xlab("FMP genes rel. abundance contributions\nto KEGG Orthologous Group") +
  ylab("KEGG Orthologous Group relative abundance") + facet_grid(Visit~Groupe)




sample_metadata_metaG %>%
  filter(Subject!="276001094") %>% #exclude contaminated CP3
  merge(KO_contrib_per_individual, by.x="seq", by.y="variable") %>%
  #filter(group == "V4_ATN.3") %>%
  #filter(Visit != "V4") %>%
  group_by(seq) %>%
  mutate(sum_kegg=sum(value.x)) %>%
  ungroup() %>%
  mutate(prop.x=value.x/sum_kegg, prop.y=value.y/sum_kegg) %>%
  #filter(prop.x> 0.0001) %>%
  ggplot() + geom_point(aes(x=value+10^-6,y=prop.x+10^-6, col=group), alpha=0.5) + 
  scale_x_log10() + scale_y_log10() +
  xlab("FMP genes rel. abundance contributions\nto KEGG Orthologous Group") +
  ylab("KEGG Orthologous Group relative abundance") + facet_grid(Visit~Groupe)



```




```{r}

kegg_contrib_V2=
sample_metadata_metaG %>%
  filter(Subject!="276001094") %>% #exclude contaminated CP3
  merge(KO_contrib_per_individual, by.x="seq", by.y="variable") %>%
  #filter(group == "V4_ATN.3") %>%
  filter(Visit == "V2") %>%
  group_by(seq) %>%
  mutate(sum_kegg=sum(value.x)) %>%
  ungroup() %>%
  mutate(prop.x=value.x/sum_kegg, prop.y=value.y/sum_kegg)

kegg_contrib_V4=
sample_metadata_metaG %>%
  filter(Subject!="276001094") %>% #exclude contaminated CP3
  merge(KO_contrib_per_individual, by.x="seq", by.y="variable") %>%
  #filter(group == "V4_ATN.3") %>%
  filter(Visit == "V4") %>%
  group_by(seq) %>%
  mutate(sum_kegg=sum(value.x)) %>%
  ungroup() %>%
  mutate(prop.x=value.x/sum_kegg, prop.y=value.y/sum_kegg)



KO_DNA_replication = read.table("../data-raw/KEGG_DNA_replication/KEGG_KO_DNA_replication.txt", sep="\t") %>%
  pull(V1) %>% gsub("\xa0\xa0","",.)
                    


kegg_contrib_V2 %>% #sample_frac(0.1) %>%
  merge(kegg_contrib_V4, by=c("Subject","KO")) %>%
  mutate(delta_contrib = value.y-value.x) %>%
  filter(KO %in% KO_counts_Lactobacillus$KO) %>%
  group_by(Groupe.x,KO) %>%
  summarise(mean_contrib=median(delta_contrib+10^-6), mean_KO=median(prop.x.x+10^-6)) %>%
  mutate(DNA_KO = ifelse(KO %in% KO_DNA_replication, "DNA RNA machinery","others")) %>%
  ggplot() + geom_point(aes(x=mean_KO,y=mean_contrib, color=Groupe.x), alpha=0.5) + 
  scale_y_log10(label=scales::percent) + scale_x_log10() + facet_wrap(~DNA_KO) +
  geom_hline(yintercept = 0.01) +
  xlab("average KO agregated rel. abundance\nat baseline") + ylab("average FMP gene contribution by KO\nafter consumption")
  


```

```{r}

kegg_contrib_V2 %>% #sample_frac(0.1) %>%
  merge(kegg_contrib_V4, by=c("Subject","KO")) %>%
  mutate(delta_contrib = value.y-value.x) %>%
  filter(KO %in% KO_counts_Lactobacillus$KO) %>%
  group_by(Groupe.x,KO) %>%
  summarise(mean_contrib=median(delta_contrib+10^-6), mean_KO=median(prop.x.x+10^-6)) %>%
  mutate(DNA_KO = ifelse(KO %in% KO_DNA_replication, "DNA RNA machinery","others")) %>%
  filter(mean_contrib > 0.01) %>%
  select(KO,mean_contrib) %>%
  write.csv2(file="KO_contrib_Lactobacillus.csv")


```


