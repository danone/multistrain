---
title: "between within time analysis"
output: html_notebook
---




```{r}

library(ggplot2)
library(dplyr)

devtools::load_all(reset=FALSE)  

install.packages("ggpubr") 
library(ggpubr)
install.packages("viridis") 
library(viridis)
library(viridisLite)
```



```{r}

load("tolerance_genus_JSD.rda")
load("tolerance_genus_BC.rda")
load("tolerance_unifrac.rda")

Tolerance::sample_metadata %>% head(10)
```


```{r}


tolerance_genus_JSD %>% 
  as.matrix() %>%
  reshape2::melt(value.name = "JSD") %>%
  
  merge(tolerance_genus_BC %>% 
  as.matrix() %>%
  reshape2::melt(value.name = "BC") , by=c("Var1","Var2")) %>%
  
  merge(tolerance_unifrac %>% 
  as.matrix() %>%
  reshape2::melt(value.name = "UNIFRAC") , by=c("Var1","Var2")) %>%
  
  reshape2::melt(id.vars=c("Var1","Var2")) %>%
  
  
  
  merge(.,
        Tolerance::sample_metadata %>% select(samplenr,Subject,Visit,Groupe_dose), 
        by.x="Var1", by.y="samplenr") %>%
    merge(.,
        Tolerance::sample_metadata %>% select(samplenr,Subject,Visit,Groupe_dose), 
        by.x="Var2", by.y="samplenr") %>%
  mutate(
    Subject_test = case_when(
    Subject.x == Subject.y ~ "Within Subject",
    Subject.x != Subject.y ~ "Between Subject"
      ) ,
    Group_test = case_when(
      Groupe_dose.x == Groupe_dose.y ~ "Within Group",
      Groupe_dose.x != Groupe_dose.y ~ "Between Group"
      
    ) ,
    Visit_test = case_when(
      Visit.x == Visit.y ~ "Within Visit",
      Visit.x != Visit.y ~ "Between Visit"
      
    ) 
    
    
  ) -> beta_diversity_data



save(beta_diversity_data, file="beta_diversity_data.rda")

```



```{r}

beta_diversity_data %>%
  filter(Visit.x == "V2",Group_test=="Within Group") %>%
  filter(!(Visit.y == "V2" & Subject_test=="Within Subject")) %>%
  ggplot() + 
  geom_boxplot(aes(y=value,x=Visit.y,fill=Subject_test)) + 
  facet_grid(variable~Groupe_dose.x, scales = "free_y") +
  ylab("microbiota beta-diversity") + xlab("Visit") + 
  scale_fill_discrete("") +
  cowplot::theme_cowplot()


beta_diversity_data %>%
  filter(Visit.x == "V2") %>%
  filter(!(Visit.y == "V2" & Subject_test=="Within Subject")) %>%
  ggplot() + 
  geom_boxplot(aes(y=value,x=Visit.y,fill=Group_test)) + 
  facet_grid(variable~Groupe_dose.x, scales = "free_y") +
  ylab("microbiota beta-diversity") + xlab("Visit") + 
  scale_fill_discrete("") +
  cowplot::theme_cowplot()


  
```


```{r}
# changement du noms des variables
# Visits by Days
# ATN by FMP



```




